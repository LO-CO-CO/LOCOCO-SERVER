name: Close Jira issue
on:
  issues:
    types:
      - closed

jobs:
  close-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Login to Jira
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

      - name: Extract & sanitize Jira key from title
        run: |
          set -euo pipefail
          TITLE='${{ github.event.issue.title }}'
          KEY=$(printf '%s' "$TITLE" | grep -oE '\b[A-Z]+-[0-9]+\b' | head -n1 || true)
          KEY=$(printf '%s' "$KEY" \
          | sed -e "s/[\"']//g" \
          -e 's/[\xE2\x80\x8B\xE2\x80\x8C\xE2\x80\x8D]//g' \
          -e 's/^[[:space:]]*//;s/[[:space:]]*$//' \
          | tr -cd 'A-Z0-9-')

      - name: Close Jira issue
        if: env.JIRA_KEY != ''
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ env.JIRA_KEY }}
          transition: 완료